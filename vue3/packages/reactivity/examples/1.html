<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
</head>

<body style="margin: 0; padding: 0">
    <button id="btn">一键复制</button>
    <table border="1" cellpadding="0" cellspacing="0" width="100%">
        <tr>
            <td>
                <table align="center" border="1" cellpadding="0" cellspacing="0" width="600"
                    style="border-collapse: collapse">
                    <tr>
                        <td style="background: red; font-weight: 900;">Row 1</td>
                    </tr>

                    <tr>
                        <td style="background: green;">Row 2</td>
                    </tr>

                    <tr>
                        <td style="background: orange;"><img src="https://www.bing.com/th?id=OADD2.1180875511303624_17YVATJVWSMDAY7&pid=21.2&c=16&roil=0&roit=0&roir=1&roib=1&w=472&h=247&rs=2&qlt=100" /></td>
                        
                    </tr>
                </table>
            </td>
        </tr>


    </table>

    <script>

        // Blob 转 Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        async function convertImagesToInline(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const images = doc.querySelectorAll('img');

            for (const img of images) {
                const src = img.src;
                if (src.startsWith('http')) {
                    // 将图片转为 Base64
                    const response = await fetch(src);
                    const blob = await response.blob();
                    const base64 = await blobToBase64(blob);
                    img.src = `data:${blob.type};base64,${base64}`;
                }
            }

            return doc.body.innerHTML;
        }

        async function copyHtmlToClipboard(html) {
            try {
                // 现代浏览器：使用 Clipboard API
                const blob = new Blob([html], { type: 'text/html' });
                const clipboardItem = new ClipboardItem({ 'text/html': blob });
                await navigator.clipboard.write([clipboardItem]);
                console.log('HTML 内容（含图片）复制成功！');
            } catch (err) {
                console.error('剪贴板写入失败，尝试回退方案:', err);
                // 旧浏览器回退：使用 execCommand
                // fallbackCopyHtml(html);
            }
        }

        btn.onclick = async (e) => {
            console.log('e', e.clipboardData)
            // console.log('aaa', document.querySelector('table').innerHTML)
            try {
                // const htmlContent = document.querySelector('table').innerHTML
                // // 创建包含 HTML 的 Blob 对象
                // const blob = new Blob([htmlContent], { type: 'text/html' });
                // // 构造 ClipboardItem
                // const clipboardItem = new ClipboardItem({ 'text/html': blob });
                // // 写入剪贴板
                // await navigator.clipboard.write([clipboardItem]);

                const html = document.querySelector('table').innerHTML
                const processedHtml = await convertImagesToInline(html);
                await copyHtmlToClipboard(processedHtml);
                alert('HTML 内容复制成功！');
            } catch (err) {
                console.error('复制失败:', err);
                // 降级处理：复制纯文本
                await navigator.clipboard.writeText(htmlContent);
                alert('已复制纯文本内容（样式可能丢失）');
            }
        }
    </script>
</body>

</html>